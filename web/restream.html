<html >
  <head>
    <meta charset="UTF-8">

    <style>
      p{ white-space: pre; }
    </style>

    <script type='text/javascript'>
      function _disableAllBtn() {
          document.getElementById("requestReStreamBtn").disabled = true;
          document.getElementById("requestQuestListBtn").disabled = true;
          document.getElementById("requestKillPidBtn").disabled = true;
          setTimeout(function(){document.getElementById("requestReStreamBtn").disabled = false;}, 5000);
          setTimeout(function(){document.getElementById("requestQuestListBtn").disabled = false;}, 5000);
          setTimeout(function(){document.getElementById("requestKillPidBtn").disabled = false;}, 5000);
      }
      function _requestWithURL(url, res) {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            res_json = JSON.parse(this.responseText);
            res(res_json);
          }
        };
        xhttp.open("GET", url, true);
        xhttp.send();
      }

      function requestReStream() {
        _disableAllBtn();
        var tmp_forwardLink = document.getElementById("forwardLink").value;
        var tmp_restreamRtmpLink = document.getElementById("restreamRtmpLink").value;
        var tmp_requestURL = "../live_restream?forwardLink=" + tmp_forwardLink + "&restreamRtmpLink=" + tmp_restreamRtmpLink;
        _requestWithURL(tmp_requestURL, function(res_json){
          var tmp_responseMessageElement = document.getElementById("responseMessage");
          tmp_responseMessageElement.innerHTML = "";
          tmp_responseMessageElement.innerHTML += "请求返回码（为0时说明当前任务已经添加成功）：" + res_json.code + '\n';
          tmp_responseMessageElement.innerHTML += res_json.msg;
        })
      }
      function requestQuestList() {
        _disableAllBtn();
        var tmp_requestURL = "../questlist";
        _requestWithURL(tmp_requestURL, function(res_json){
          var tmp_responseMessageElement = document.getElementById("responseMessage");
          var tmp_retStr = "任务列表为：\n";
          res_json.forEach(function(item){
            tmp_retStr += "------------------\n";
            tmp_retStr += "forwardLinkOrign：" + item['forwardLinkOrign'] + "\n";
            tmp_retStr += "rtmpLink: " + item['rtmpLink'] + "\n";
            tmp_retStr += "isSubscribeQuest: " + item['isSubscribeQuest'] + "\n";
          });
          tmp_responseMessageElement.innerHTML = tmp_retStr;
        })
      }
      function requestKillPid() {
        _disableAllBtn();
        var tmp_sercert = prompt("请输入服务器sercert", "XXXXXXXXXXXXX");
        var tmp_restreamRtmpLink = document.getElementById("restreamRtmpLink").value;
        var tmp_requestURL = "../kill_quest?rtmpLink=" + tmp_restreamRtmpLink + '&sercert=' + tmp_sercert;
        _requestWithURL(tmp_requestURL, function(res_json){
          var tmp_responseMessageElement = document.getElementById("responseMessage");
          tmp_responseMessageElement.innerHTML = JSON.stringify(res_json);
        })
      }
    </script>

    <title>手动转播</title>
  </head>
  <p>
    转播地址例子：
      Youtube地址：
      https://www.youtube.com/watch?v=XXXXXX 或者 https://youtu.be/watch?v=XXXXXX
      https://www.youtube.com/channel/XXXXXXX/live 或者 https://youtu.be/channel/XXXXXXX/live

    twitcasting地址:
      https://twitcasting.tv/XXXXXXXXXX

    m3u8地址：
      http://XXXXXXXXX.m3u8
        或其它是m3u8的地址，可能后面带点东西的像 openREC的
      http://XXXXXXXXX.m3u8?/video=1

    推流地址例子：
      B站的地址是两串合起来的，像youtube那些也是path+key,两串合起来
      rtmp://XXXXXX.acg.tv/live-js/?streamname=live_XXXXXXX&key=XXXXXXXXXX
  </p>
  <label >转播源地址：</label> <input type="text" id="forwardLink" name="forwardLink" size="128"><br /><br />
  <label >推流目标地址:</label> <input type="text" id="restreamRtmpLink" name ="restreamRtmpLink" size="128"><br /><br />
  <button id="requestReStreamBtn" onclick="requestReStream()">开始转播</button>
  <button id="requestQuestListBtn" onclick="requestQuestList()">查看任务列表</button>
  <button id="requestKillPidBtn" onclick="requestKillPid()">强行关闭任务</button>

  <p id="responseMessage"><p/>
</html>
